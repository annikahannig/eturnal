{minimum_otp_vsn, "21.0"}.

{deps,
 [{stun, {git, "https://github.com/processone/stun.git", {tag, "1.0.41"}}},
  {conf, {git, "https://github.com/processone/conf.git", {tag, "0.1.1"}}},
  {recon, {git, "https://github.com/ferd/recon.git", {tag, "2.5.1"}}},
  {influx_udp, {git, "https://github.com/palkan/influx_udp.git", {tag, "v1.1.0"}}}]}.

{relx,
 [{release, {eturnal, {cmd, "scripts/get-version"}},
   [eturnal,
    sasl,
    runtime_tools,
    recon,
    {influx_udp, none},
    {poolboy, none},
    {ulitos, none}]},
  {mode, dev},
  {src_tests, true},
  {sys_config, "./config/sys.config"},
  {vm_args, "./config/vm.args"},
  {extended_start_script_hooks,
   [{pre_start,
     [{custom, "hooks/pre_start"}]},
    {post_start,
     [{wait_for_process, eturnal}]}]},
  {extended_start_script_extensions,
   [{info, "extensions/info"},
    {loglevel, "extensions/loglevel"},
    {reload, "extensions/reload"},
    {sessions, "extensions/sessions"},
    {version, "extensions/version"}]},
  {overlay_vars, "build.config"},
  {overlay,
   [{copy, "LICENSE", "doc/LICENSE.txt"},
    {copy, "CHANGELOG.md", "doc/CHANGELOG.md"},
    {copy, "README.md", "doc/README.md"},
    {copy, "config/eturnal.yml", "etc/eturnal.yml"},
    {copy, "scripts/hooks/pre_start", "bin/hooks/pre_start"},
    {copy, "scripts/extensions/info", "bin/extensions/info"},
    {copy, "scripts/extensions/loglevel", "bin/extensions/loglevel"},
    {copy, "scripts/extensions/reload", "bin/extensions/reload"},
    {copy, "scripts/extensions/sessions", "bin/extensions/sessions"},
    {template, "scripts/extensions/version", "bin/extensions/version"},
    {template, "scripts/eturnalctl", "bin/eturnalctl"},
    {template, "scripts/eturnal.init", "etc/init.d/eturnal"},
    {template, "config/eturnal.service", "etc/systemd/system/eturnal.service"}]}]}.

{erl_opts,
 [{platform_define, "^21\.[0-2]\.", old_persistent_term},
  {platform_define, "^21\.[0-2]\.", old_logger},
  {platform_define, "^2[12]\.", old_crypto},
  debug_info]}.

{dialyzer,
 [{warnings,
   [unknown,
    no_return,
    no_unused,
    no_improper_lists,
    no_fun_app,
    no_match,
    no_opaque,
    no_fail_call,
    no_contracts,
    no_behaviours,
    no_undefined_callbacks,
    unmatched_returns,
    error_handling,
    race_conditions]},
  {plt_extra_apps, % Nested dependencies which we call directly.
   [fast_tls,
    yval,
    influx_udp]}]}.

{xref_checks,
 [undefined_function_calls,
  undefined_functions,
  deprecated_function_calls,
  deprecated_functions,
  locals_not_used]}.

{profiles,
 [{prod,
   [{relx,
     [{mode, prod}]},
    {erl_opts,
     [warnings_as_errors]}]},
  % Stripped-down binary release:
  {stripped,
   [{relx,
     [{mode, prod},
      {exclude_apps,
       [sasl,
        runtime_tools,
        recon]}]},
    {erl_opts,
     [no_debug_info,
      deterministic,
      warnings_as_errors]}]},
  % Distribution packaging:
  {distro,
   [{relx,
     [{mode, minimal},
      {system_libs, false},
      {exclude_apps,
       [sasl,
        runtime_tools,
        recon,
        influx_udp,
        poolboy,
        ulitos]}]},
    {erl_opts,
     [no_debug_info,
      deterministic]}]},
  {test,
   [{erl_opts,
     [warnings_as_errors,
      nowarn_export_all]}]}]}.

{overrides,
 [{del, stun,
   [{erl_opts, % Let 'stun' use the new logging API on Erlang/OTP 21 as well.
     [{platform_define, "^(R|1|20|21)", 'USE_OLD_LOGGER'}]}]}]}.

{pre_hooks,
 [{release, "chmod o-rw config/eturnal.yml"},
  {tar, "chmod o-rw config/eturnal.yml"}]}.

{plugins,
 [rebar3_run]}.

{alias,
 [{check,
   [xref,
    dialyzer,
    ct]},
  {bump,
   [{clean, "-a"},
    update,
    upgrade]}]}.
